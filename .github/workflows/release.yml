name: release
on: [push, pull_request]
# on:
#   push:
#     tags:
#       - '*'

env:
  DEVELOPER_DIR: /Applications/Xcode_13.4.1.app/Contents/Developer
  IOS_DEPLOYMENT_TARGET: '9.0'
  MAC_DEPLOYMENT_TARGET: '10.9'
  MAC_ARM64_DEPLOYMENT_TARGET: '11.0'
  MAC_CATALYST_DEPLOYMENT_TARGET: '13.1'
  ENABLE_BITCODE: OFF
  ENABLE_ARC: OFF
  ENABLE_VISIBILITY: OFF
  EMSCRIPTEN_VERSION: 3.1.28

permissions:
  contents: read

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      VERSION: ${{ steps.get_version.outputs.VERSION }}
    steps:
    - name: get-version
      id: get_version
      run: echo "VERSION=${GITHUB_REF/refs\/tags\//}" >> $GITHUB_OUTPUT
    - name: opencv2-source
      run: |
        wget -q https://github.com/opencv/opencv/archive/2.4.13.7.zip -O opencv-2.4.13.7.zip
        unzip -q opencv-2.4.13.7.zip
        rm opencv-2.4.13.7.zip
        cd opencv-2.4.13.7
        truncate -s 0 cmake/OpenCVFindLibsGrfmt.cmake
        patch -p1 -i ../opencv-2.4.13.7-no-rtti.patch
        patch -p1 -i ../opencv-2.4.13.7-no-zlib.patch
        patch -p1 -i ../opencv-2.4.13.7-fix-highgui-include.patch
        patch -p1 -i ../opencv-2.4.13.7-no-link-stdc++.patch
        patch -p1 -i ../opencv-2.4.13.7-enable-cxx11.patch
        patch -p1 -i ../opencv-2.4.13.7-link-openmp.patch
        patch -p1 -i ../opencv-2.4.13.7-newer-msvc.patch
        patch -p1 -i ../opencv-2.4.13.7-minimal-install.patch
        rm -rf modules/highgui
        cp -r ../highgui modules/
        cp ../misc/draw_text.h ../misc/mono_font_data.h modules/core/src/
        patch -p1 -i ../opencv-2.4.13.7-drawing-mono-font.patch
        cd ..
        zip -9 -r opencv-2.4.13.7.zip opencv-2.4.13.7
    - name: opencv3-source
      run: |
        wget -q https://github.com/opencv/opencv/archive/3.4.20.zip -O opencv-3.4.20.zip
        unzip -q opencv-3.4.20.zip
        rm opencv-3.4.20.zip
        cd opencv-3.4.20
        truncate -s 0 cmake/OpenCVFindLibsGrfmt.cmake
        patch -p1 -i ../opencv-3.4.20-no-rtti.patch
        patch -p1 -i ../opencv-3.4.20-no-zlib.patch
        patch -p1 -i ../opencv-3.4.20-link-openmp.patch
        patch -p1 -i ../opencv-3.4.20-minimal-install.patch
        rm -rf modules/highgui
        cp -r ../highgui modules/
        cp ../misc/draw_text.h ../misc/mono_font_data.h modules/imgproc/src/
        patch -p1 -i ../opencv-3.4.20-drawing-mono-font.patch
        cd ..
        zip -9 -r opencv-3.4.20.zip opencv-3.4.20
    - name: opencv4-source
      run: |
        wget -q https://github.com/opencv/opencv/archive/4.8.1.zip -O opencv-4.8.1.zip
        unzip -q opencv-4.8.1.zip
        rm opencv-4.8.1.zip
        cd opencv-4.8.1
        truncate -s 0 cmake/OpenCVFindLibsGrfmt.cmake
        rm -rf modules/gapi
        patch -p1 -i ../opencv-4.8.1-no-rtti.patch
        patch -p1 -i ../opencv-4.8.1-no-zlib.patch
        patch -p1 -i ../opencv-4.8.1-link-openmp.patch
        patch -p1 -i ../opencv-4.8.1-minimal-install.patch
        rm -rf modules/highgui
        cp -r ../highgui modules/
        cp ../misc/draw_text.h ../misc/mono_font_data.h modules/imgproc/src/
        patch -p1 -i ../opencv-4.8.1-drawing-mono-font.patch
        cd ..
        zip -9 -r opencv-4.8.1.zip opencv-4.8.1
    - name: upload-opencv2-source
      uses: actions/upload-artifact@v3
      with:
        name: opencv2-source
        path: opencv-2.4.13.7.zip
    - name: upload-opencv3-source
      uses: actions/upload-artifact@v3
      with:
        name: opencv3-source
        path: opencv-3.4.20.zip
    - name: upload-opencv4-source
      uses: actions/upload-artifact@v3
      with:
        name: opencv4-source
        path: opencv-4.8.1.zip

